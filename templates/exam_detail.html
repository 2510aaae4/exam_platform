<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>考試詳情</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .notes-textarea {
            resize: vertical;
            min-height: 100px;
        }
        .saving-indicator {
            display: none;
            color: #000;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        /* 選項樣式 */
        .option-item {
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .option-user-answer {
            background-color: #e3f2fd;  /* 使用者答案背景色 */
            border-color: #90caf9;
        }
        .option-correct {
            border-color: #4caf50;
        }
        .answer-badge {
            font-size: 0.875rem;
            padding: 2px 8px;
            margin-left: 8px;
            border-radius: 4px;
        }
        .user-answer-badge {
            background-color: #2196f3;
            color: white;
        }
        .correct-answer-badge {
            background-color: #4caf50;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>{{ exam_title }}</h2>
            <div>
                <span class="h4 me-3">得分：{{ score }}</span>
                <a href="/past_exams" class="btn btn-outline-primary">返回記錄</a>
            </div>
        </div>

        {% for question in questions %}
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">第 {{ question.number }} 題</h5>
                    <div>
                        {% if question.confidence %}
                        <span class="badge bg-{{ 'success' if question.confidence == 'high' else 'warning' if question.confidence == 'medium' else 'danger' }}">
                            {{ '高' if question.confidence == 'high' else '中' if question.confidence == 'medium' else '低' }}把握度
                        </span>
                        {% endif %}
                        <span class="badge bg-{{ 'success' if question.is_correct else 'danger' }} ms-2">
                            {{ '正確' if question.is_correct else '錯誤' }}
                        </span>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <p>{{ question.content }}</p>
                {% if question.image %}
                <img src="{{ url_for('static', filename=question.image) }}" class="img-fluid mb-3" alt="題目圖片">
                {% endif %}
                
                <div class="options">
                    {% for option in question.options %}
                    <div class="option-item {{ 'option-user-answer' if option.is_user_answer }} {{ 'option-correct' if option.is_correct }}">
                        {{ option.content }}
                        {% if option.is_user_answer %}
                        <span class="answer-badge user-answer-badge">您的答案</span>
                        {% endif %}
                        {% if option.is_correct %}
                        <span class="answer-badge correct-answer-badge">正確答案</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <div class="notes-section">
                    <h4>我的筆記</h4>
                    <textarea class="form-control note-input" rows="3" 
                              data-exam-record-id="{{ exam_record.id }}" 
                              data-question-number="{{ loop.index }}"
                              placeholder="在這裡輸入你的筆記..."></textarea>
                    <div class="saving-indicator mt-2" id="saving-indicator-{{ loop.index }}">
                        <small class="text-muted">正在儲存...</small>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <script>
        // 為每個筆記文本框添加自動保存功能
        document.querySelectorAll('.note-input').forEach(textarea => {
            let saveTimeout;
            let lastContent = textarea.value;
            const savingIndicator = document.getElementById(`saving-indicator-${textarea.dataset.questionNumber}`);

            // 載入已有的筆記
            const record_id = textarea.dataset.examRecordId;
            const question_num = textarea.dataset.questionNumber;
            
            // 載入筆記
            fetch(`/api/exam-notes/${record_id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.notes && data.notes[question_num]) {
                        const notes = data.notes[question_num];
                        if (notes.length > 0) {
                            textarea.value = notes[0].content;
                            lastContent = notes[0].content;
                        }
                    }
                })
                .catch(error => {
                    console.error('載入筆記失敗:', error);
                });

            textarea.addEventListener('input', function() {
                // 如果內容沒有變化，不需要保存
                if (this.value === lastContent) return;
                
                // 清除之前的計時器
                if (saveTimeout) clearTimeout(saveTimeout);
                
                // 顯示儲存指示器
                savingIndicator.style.display = 'block';
                
                // 設置新的計時器
                saveTimeout = setTimeout(() => {
                    const content = this.value.trim();
                    if (content === lastContent) {
                        savingIndicator.style.display = 'none';
                        return;
                    }
                    
                    lastContent = content;
                    
                    // 準備筆記數據
                    const notes = {};
                    notes[question_num] = content;

                    fetch('/api/save-notes', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            record_id: record_id,
                            notes: notes
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        savingIndicator.style.display = 'none';
                        if (data.success) {
                            console.log('筆記已儲存');
                        } else {
                            console.error('儲存失敗:', data.message);
                            alert('儲存失敗: ' + data.message);
                        }
                    })
                    .catch(error => {
                        savingIndicator.style.display = 'none';
                        console.error('Error:', error);
                        alert('儲存時發生錯誤');
                    });
                }, 1000);  // 延遲1秒再保存
            });
        });
    </script>
</body>
</html>
